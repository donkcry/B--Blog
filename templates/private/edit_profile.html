{% extends 'base.html' %}
{% load static %}

{% block title %}编辑个人信息{% endblock %}

{% block head %}
    <style>
        /* 核心：深色悬浮提示框样式 */
        .floating-alert {
            position: fixed; /* 悬浮在页面顶部 */
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px); /* 初始上移隐藏 */
            background-color: #333; /* 深色背景 */
            color: #fff; /* 白色文字 */
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 9999; /* 最上层显示 */
            opacity: 0; /* 默认隐藏 */
            transition: all 0.5s ease; /* 渐变动画 */
        }
        /* 提示框显示状态 */
        .floating-alert.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0); /* 显示时回到原位 */
        }

        /* 原有表单样式保留，仅移除弹窗相关样式 */
        .form-card {
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid rgba(0,0,0,.125);
            border-radius: 0.5rem;
            margin-top: 30px;
        }
        .form-header {
            padding: 1rem 1.25rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid rgba(0,0,0,.125);
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .form-body { padding: 1.5rem; }
        .code-btn {
            width: 120px;
        }
        .code-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
{% endblock %}

{% block main %}
    <!-- 1. 悬浮提示框容器（核心新增） -->
    <div id="floatingAlert" class="floating-alert">
        <span id="alertText"></span>
    </div>

    <!-- 2. 原有表单卡片 -->
    <div class="form-card">
        <div class="form-header">
            <h3 class="h5 mb-0">编辑个人信息</h3>
        </div>
        <div class="form-body">
            <form method="post" id="profileForm">
                {% csrf_token %}
                <div class="row g-3">
                    <!-- 原邮箱（只读） -->
                    <div class="col-md-6">
                        <label for="{{ form.email.id_for_label }}" class="form-label">
                            {{ form.email.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger small mt-1">{{ form.email.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- 新邮箱输入框 -->
                    <div class="col-md-6">
                        <label for="{{ form.new_email.id_for_label }}" class="form-label">
                            {{ form.new_email.label }}
                        </label>
                        {{ form.new_email }}
                        {% if form.new_email.errors %}
                            <div class="text-danger small mt-1">{{ form.new_email.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- 邮箱验证码输入框 + 发送按钮 -->
                    <div class="col-md-6">
                        <label for="{{ form.email_verify_code.id_for_label }}" class="form-label">
                            {{ form.email_verify_code.label }}
                        </label>
                        <div class="input-group">
                            {{ form.email_verify_code }}
                            <button type="button" class="btn btn-outline-secondary code-btn" id="sendEmailCodeBtn">
                                发送验证码
                            </button>
                        </div>
                        {% if form.email_verify_code.errors %}
                            <div class="text-danger small mt-1">{{ form.email_verify_code.errors.0 }}</div>
                        {% endif %}
                    </div>

                    {% for field in form %}
                        {% if field.name not in 'email,new_email,email_verify_code' %}
                            <div class="col-md-6">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ field }}
                                {% if field.errors %}
                                    <div class="text-danger small mt-1">{{ field.errors.0 }}</div>
                                {% endif %}
                                {% if field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="mt-4 d-flex gap-2">
                    <button type="submit" class="btn btn-outline-dark">
                        <i class="bi bi-save"></i> 保存修改
                    </button>
                    <a href="{% url 'private:user_profile' %}" class="btn btn-outline-dark">
                        <i class="bi bi-arrow-left"></i> 返回个人中心
                    </a>
                </div>
            </form>

            <script>
                // 核心：显示悬浮提示框的函数（3秒后自动消失）
                function showFloatingAlert(message) {
                    const alertBox = document.getElementById('floatingAlert');
                    const alertText = document.getElementById('alertText');

                    // 设置提示文本
                    alertText.textContent = message;
                    // 显示提示框
                    alertBox.classList.add('show');

                    // 3秒后渐变隐藏
                    setTimeout(() => {
                        alertBox.classList.remove('show');
                    }, 3000);
                }

                // 1. 页面加载时，显示django messages提示（比如保存成功）
                {% if messages %}
                    {% for message in messages %}
                        showFloatingAlert("{{ message }}");
                    {% endfor %}
                {% endif %}

                // 2. 发送邮箱验证码逻辑（提示改为悬浮框）
                const sendEmailCodeBtn = document.getElementById('sendEmailCodeBtn');
                const newEmailInput = document.getElementById('{{ form.new_email.id_for_label }}');
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                sendEmailCodeBtn.addEventListener('click', async () => {
                    const newEmail = newEmailInput.value.trim();
                    if (!newEmail) {
                        showFloatingAlert('请先输入新邮箱'); // 悬浮提示
                        return;
                    }

                    sendEmailCodeBtn.disabled = true;
                    sendEmailCodeBtn.textContent = '发送中...';

                    try {
                        const response = await fetch("{% url 'private:send_email_change_code' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ new_email: newEmail })
                        });
                        const data = await response.json();
                        showFloatingAlert(data.msg); // 悬浮提示

                        if (data.status === 'success') {
                            let count = 60;
                            const timer = setInterval(() => {
                                sendEmailCodeBtn.textContent = `${count}秒后重试`;
                                count--;
                                if (count < 0) {
                                    clearInterval(timer);
                                    sendEmailCodeBtn.disabled = false;
                                    sendEmailCodeBtn.textContent = '发送验证码';
                                }
                            }, 1000);
                        } else {
                            sendEmailCodeBtn.disabled = false;
                            sendEmailCodeBtn.textContent = '发送验证码';
                        }
                    } catch (e) {
                        showFloatingAlert('发送请求失败，请重试'); // 悬浮提示
                        sendEmailCodeBtn.disabled = false;
                        sendEmailCodeBtn.textContent = '发送验证码';
                    }
                });

                // 3. 表单提交逻辑（提示改为悬浮框）
                const profileForm = document.getElementById('profileForm');
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = new FormData(profileForm);
                    try {
                        const response = await fetch(window.location.href, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        const html = await response.text();
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;

                        // 检查表单错误
                        const errorElements = tempDiv.querySelectorAll('.text-danger small');
                        if (errorElements.length > 0) {
                            const firstError = errorElements[0].textContent.trim();
                            showFloatingAlert(firstError); // 悬浮提示错误
                        } else {
                            showFloatingAlert('个人信息修改成功！'); // 悬浮提示成功
                            setTimeout(() => window.location.reload(), 1500);
                        }
                    } catch (err) {
                        showFloatingAlert('网络错误，请稍后重试！'); // 悬浮提示
                    }
                });
            </script>
        </div>
    </div>
{% endblock %}