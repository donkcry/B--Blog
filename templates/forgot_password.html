{% extends 'base.html'%}

{% block title %}忘记密码{% endblock %}

{% block head %}
    <style>
        /* 补充局部样式，避免布局错位 */
        .forgot-password-container {
            max-width: 330px !important;
        }
        /* 验证码输入框和按钮的适配 */
        .captcha-group {
            display: flex;
            align-items: stretch;
            gap: 8px;
        }
        .captcha-group input {
            flex: 1; /* 输入框占满剩余宽度 */
        }
        .captcha-group button {
            white-space: nowrap; /* 按钮文字不换行 */
            padding: 0 16px; /* 按钮内边距统一 */
        }
        /* 重置密码表单分隔线样式优化 */
        .reset-form-hr {
            border-color: #e9ecef;
            margin: 1rem 0;
        }
    </style>
{% endblock %}

{% block main %}
    <div class="forgot-password-container m-auto mt-5">
        <h1 class="text-center mb-4">忘记密码</h1>
        {% csrf_token %}
        <!-- 邮箱输入框 -->
        <div class="mb-3">
            <label class="form-label mb-1">注册邮箱</label>
            <input type="email" class="form-control" id="email"
                   placeholder="请输入您的注册邮箱" autocomplete="off">
        </div>

        <!-- 验证码输入 + 发送按钮 -->
        <div class="mb-3 captcha-group">
            <input type="text" class="form-control" id="captcha"
                   placeholder="请输入验证码" autocomplete="off">
            <button class="btn btn-outline-dark" id="sendCaptchaBtn">发送验证码</button>
        </div>

        <!-- 验证按钮 -->
        <button class="btn btn-outline-dark w-100 mb-4" id="verifyBtn">验证</button>

        <!-- 重置密码表单（默认隐藏） -->
        <div id="resetPasswordForm" class="mt-2 d-none">
            <hr class="reset-form-hr">
            <h5 class="text-center mb-3">重置密码</h5>

            <div class="mb-3">
                <label class="form-label mb-1">新密码</label>
                <input type="password" class="form-control" id="newPassword"
                       placeholder="6-20位密码" autocomplete="new-password">
            </div>

            <div class="mb-3">
                <label class="form-label mb-1">确认新密码</label>
                <input type="password" class="form-control" id="confirmPassword"
                       placeholder="再次输入新密码" autocomplete="new-password">
            </div>

            <button class="btn btn-outline-dark w-100 mb-5" id="resetBtn">确认重置</button>
        </div>
    </div>

    <script>


        function showCustomAlert(message, type = 'info', duration = 3000) {
            // 移除旧弹窗
            const oldAlert = document.querySelector('.custom-alert');
            if (oldAlert) oldAlert.remove();

            // 创建新弹窗
            const alertBox = document.createElement('div');
            alertBox.className = `custom-alert ${type}`;
            alertBox.innerText = message;

            // 弹窗核心样式（无需依赖base.html）
            alertBox.style.position = 'fixed';
            alertBox.style.top = '20px';
            alertBox.style.left = '50%';
            alertBox.style.transform = 'translateX(-50%)';
            alertBox.style.padding = '15px 30px';
            alertBox.style.background = type === 'success' ? '#28a745' : (type === 'error' ? '#dc3545' : '#17a2b8');
            alertBox.style.color = 'white';
            alertBox.style.borderRadius = '8px';
            alertBox.style.zIndex = '9999';
            alertBox.style.opacity = '0';
            alertBox.style.transition = 'opacity 0.3s ease-in-out, top 0.3s ease-in-out';
            alertBox.style.pointerEvents = 'none';
            alertBox.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';

            document.body.appendChild(alertBox);

            // 显示动画
            setTimeout(() => {
                alertBox.style.opacity = '1';
                alertBox.style.top = '30px';
            }, 10);

            // 自动消失
            setTimeout(() => {
                alertBox.style.opacity = '0';
                alertBox.style.top = '20px';
                setTimeout(() => alertBox.remove(), 300);
            }, duration);
        }


        document.addEventListener('DOMContentLoaded', function() {
            const emailInput = document.getElementById('email');
            const captchaInput = document.getElementById('captcha');
            const sendBtn = document.getElementById('sendCaptchaBtn');
            const verifyBtn = document.getElementById('verifyBtn');
            const resetForm = document.getElementById('resetPasswordForm');
            const newPwdInput = document.getElementById('newPassword');
            const confirmPwdInput = document.getElementById('confirmPassword');
            const resetBtn = document.getElementById('resetBtn');

            // 标记是否验证通过
            let isCaptchaVerified = false;

            // 发送验证码逻辑
            sendBtn.addEventListener('click', function() {
                const email = emailInput.value.trim();
                if (!email) {
                    showCustomAlert('请输入注册邮箱！', 'error');
                    return;
                }

                // 按钮状态锁定
                sendBtn.disabled = true;
                sendBtn.innerText = '发送中...';

                // 调用验证码接口
                fetch(`{% url 'BLauth:send_forgot_captcha' %}?email=${email}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.code === 200) {
                            showCustomAlert(data.message, 'success');
                            // 60秒倒计时逻辑
                            let count = 60;
                            const timer = setInterval(() => {
                                sendBtn.innerText = `重新发送(${count}s)`;
                                count--;
                                if (count < 0) {
                                    clearInterval(timer);
                                    sendBtn.innerText = '发送验证码';
                                    sendBtn.disabled = false;
                                }
                            }, 1000);
                        } else {
                            showCustomAlert(data.message, 'error');
                            sendBtn.disabled = false;
                            sendBtn.innerText = '发送验证码';
                        }
                    })
                    .catch(err => {
                        showCustomAlert('网络错误，请重试！', 'error');
                        sendBtn.disabled = false;
                        sendBtn.innerText = '发送验证码';
                    });
            });

            // 验证验证码逻辑
            verifyBtn.addEventListener('click', function() {
                const email = emailInput.value.trim();
                const captcha = captchaInput.value.trim();

                // 基础校验
                if (!email) {
                    showCustomAlert('请输入邮箱！', 'error');
                    return;
                }
                if (!captcha) {
                    showCustomAlert('请输入验证码！', 'error');
                    return;
                }

                // 调用验证接口
                fetch(`{% url 'BLauth:verify_forgot_captcha' %}?email=${email}&captcha=${captcha}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.code === 200) {
                            showCustomAlert(data.message, 'success');
                            isCaptchaVerified = true;
                            resetForm.classList.remove('d-none'); // 显示重置密码表单
                            // 自动聚焦到新密码输入框
                            newPwdInput.focus();
                        } else {
                            showCustomAlert(data.message, 'error');
                        }
                    })
                    .catch(err => {
                        showCustomAlert('网络错误，请重试！', 'error');
                    });
            });

            // 重置密码逻辑
            resetBtn.addEventListener('click', function() {
                if (!isCaptchaVerified) {
                    showCustomAlert('请先验证验证码！', 'error');
                    return;
                }

                const newPwd = newPwdInput.value.trim();
                const confirmPwd = confirmPwdInput.value.trim();

                // 密码校验
                if (newPwd.length < 6 || newPwd.length > 20) {
                    showCustomAlert('密码长度需在6-20位之间！', 'error');
                    newPwdInput.focus();
                    return;
                }
                if (newPwd !== confirmPwd) {
                    showCustomAlert('两次输入的密码不一致！', 'error');
                    confirmPwdInput.focus();
                    return;
                }

                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                // 调用重置密码接口（这里需要补充后端接口）
                fetch(`{% url 'BLauth:reset_password' %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        email: emailInput.value.trim(),
                        new_password: newPwd
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.code === 200) {
                            showCustomAlert('密码重置成功！即将跳转到登录页', 'success');
                            setTimeout(() => {
                                window.location.href = "{% url 'BLauth:login' %}";
                            }, 2000);
                        } else {
                            showCustomAlert(data.message, 'error');
                        }
                    })
                    .catch(err => {
                        showCustomAlert('重置密码失败，请重试！', 'error');
                    });
            });
        });
    </script>
{% endblock %}