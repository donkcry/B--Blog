{% extends 'base.html'%}

{% load static %}

{% block title %}注册{% endblock %}

{% block head %}
    <style>
        /* 自定义弹窗样式（和忘记密码页统一） */
        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 0.3s ease-in-out;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
        }
        .custom-alert.success { background: #1a1d20; }
        .custom-alert.error { background: #1a1d20; }
        .custom-alert.info { background: darkred; }
        .custom-alert.show {
            opacity: 1;
            top: 30px;
            pointer-events: auto;
        }
    </style>
{% endblock %}

{% block main %}
    <div style="max-width: 330px" class="m-auto mt-5">
        <h1 class="text-center mb-4">注册</h1>
        <form id="registerForm" method="post">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label">用户名</label>
                <input type="text" class="form-control" name="username" placeholder="请输入用户名" autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">QQ邮箱</label>
                <input type="email" class="form-control" name="email" placeholder="仅支持QQ邮箱（xxx@qq.com）" autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">验证码</label>
                <div class="input-group">
                    <input type="text" class="form-control" name="captcha" placeholder="请输入4位验证码" autocomplete="off">
                    <button class="btn btn-outline-dark" type="button" id="captcha-btn">获取验证码</button>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label">密码</label>
                <input type="password" class="form-control" name="password" placeholder="6-20位密码" autocomplete="new-password">
            </div>
            <button class="btn btn-outline-dark w-100 mb-4" type="submit">注册</button>
        </form>
    </div>

    <script>
        // 1. 自定义弹窗函数（和忘记密码页统一）
        function showCustomAlert(message, type = 'info', duration = 3000) {
            // 移除旧弹窗
            const oldAlert = document.querySelector('.custom-alert');
            if (oldAlert) oldAlert.remove();

            // 创建新弹窗
            const alertBox = document.createElement('div');
            alertBox.className = `custom-alert ${type}`;
            alertBox.innerText = message;
            document.body.appendChild(alertBox);

            // 显示弹窗
            setTimeout(() => alertBox.classList.add('show'), 10);

            // 自动消失
            setTimeout(() => {
                alertBox.classList.remove('show');
                setTimeout(() => alertBox.remove(), 300);
            }, duration);
        }

        // 2. 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            const emailInput = registerForm.querySelector('input[name="email"]');
            const captchaBtn = document.getElementById('captcha-btn');
            const usernameInput = registerForm.querySelector('input[name="username"]');
            const passwordInput = registerForm.querySelector('input[name="password"]');
            const captchaInput = registerForm.querySelector('input[name="captcha"]');

            // 3. 发送验证码逻辑
            captchaBtn.addEventListener('click', function() {
                // 前置校验
                const email = emailInput.value.trim();
                if (!email) {
                    showCustomAlert('请输入QQ邮箱！', 'error');
                    return;
                }
                if (!email.endsWith('@qq.com')) {
                    showCustomAlert('仅支持QQ邮箱注册！', 'error');
                    return;
                }

                // 禁用按钮 + 倒计时
                captchaBtn.disabled = true;
                captchaBtn.innerText = '发送中...';

                // 调用验证码接口
                fetch(`{% url 'BLauth:captcha' %}?email=${email}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.code === 200) {
                            showCustomAlert('验证码已发送至您的QQ邮箱！', 'success');
                            // 60秒倒计时
                            let count = 60;
                            const timer = setInterval(() => {
                                captchaBtn.innerText = `重新发送(${count}s)`;
                                count--;
                                if (count < 0) {
                                    clearInterval(timer);
                                    captchaBtn.innerText = '获取验证码';
                                    captchaBtn.disabled = false;
                                }
                            }, 1000);
                        } else {
                            showCustomAlert(data.message, 'error');
                            captchaBtn.disabled = false;
                            captchaBtn.innerText = '获取验证码';
                        }
                    })
                    .catch(err => {
                        showCustomAlert('网络错误，请重试！', 'error');
                        captchaBtn.disabled = false;
                        captchaBtn.innerText = '获取验证码';
                    });
            });

            // 4. 表单提交校验
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault(); // 阻止默认提交

                // 前端基础校验
                const username = usernameInput.value.trim();
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                const captcha = captchaInput.value.trim();

                if (!username) {
                    showCustomAlert('请输入用户名！', 'error');
                    usernameInput.focus();
                    return;
                }
                if (!email || !email.endsWith('@qq.com')) {
                    showCustomAlert('请输入有效的QQ邮箱！', 'error');
                    emailInput.focus();
                    return;
                }
                if (!captcha || captcha.length !== 4) {
                    showCustomAlert('请输入4位验证码！', 'error');
                    captchaInput.focus();
                    return;
                }
                if (password.length < 6 || password.length > 20) {
                    showCustomAlert('密码长度需在6-20位之间！', 'error');
                    passwordInput.focus();
                    return;
                }

                // 提交表单（原生方式）
                this.submit();
            });

            // 5. 捕获后端返回的错误（注册失败时弹窗提示）
            {% if form.errors %}
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        showCustomAlert('{{ error }}', 'error');
                    {% endfor %}
                {% endfor %}
            {% endif %}
        });
    </script>
{% endblock %}