{% extends 'base.html'%}
{% load static %}
{% block title %}注册{% endblock %}
{% block head %}
    <style>
        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 0.3s ease-in-out;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
        }
        .custom-alert.success { background: #1a1d20; }
        .custom-alert.error { background: #1a1d20; }
        .custom-alert.info { background: darkred; }
        .custom-alert.show {
            opacity: 1;
            top: 30px;
            pointer-events: auto;
        }
    </style>
{% endblock %}
{% block main %}
    <div style="max-width: 330px" class="m-auto">
        <h1 class="text-center mb-4">注册</h1>
        <form id="registerForm" method="post">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label">用户名</label>
                <input type="text" class="form-control" name="username" placeholder="请输入用户名" autocomplete="off"
                       value="{{ form.username.value|default:'' }}">
            </div>
            <div class="mb-3">
                <label class="form-label">QQ邮箱</label>
                <input type="email" class="form-control" name="email" placeholder="仅支持QQ邮箱（xxx@qq.com）" autocomplete="off"
                       value="{{ form.email.value|default:'' }}">
            </div>
            <div class="mb-3">
                <label class="form-label">验证码</label>
                <div class="input-group">
                    <input type="text" class="form-control" name="captcha" placeholder="请输入4位验证码" autocomplete="off">
                    <button class="btn btn-outline-dark" type="button" id="captcha-btn">获取验证码</button>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label">密码</label>
                <input type="password" class="form-control" name="password" placeholder="6-20位密码" autocomplete="new-password">
            </div>
            <button class="btn btn-outline-dark w-100 mb-4" type="submit">注册</button>
        </form>
    </div>

    <script>
        function showCustomAlert(message, type = 'info', duration = 3000) {
            const oldAlert = document.querySelector('.custom-alert');
            if (oldAlert) oldAlert.remove();
            const alertBox = document.createElement('div');
            alertBox.className = `custom-alert ${type}`;
            alertBox.innerText = message;
            document.body.appendChild(alertBox);
            setTimeout(() => alertBox.classList.add('show'), 10);
            setTimeout(() => {
                alertBox.classList.remove('show');
                setTimeout(() => alertBox.remove(), 300);
            }, duration);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            const emailInput = registerForm.querySelector('input[name="email"]');
            const captchaBtn = document.getElementById('captcha-btn');
            const usernameInput = registerForm.querySelector('input[name="username"]');
            const passwordInput = registerForm.querySelector('input[name="password"]');
            const captchaInput = registerForm.querySelector('input[name="captcha"]');

            // register.html - 验证码发送逻辑
            captchaBtn.addEventListener('click', function() {
                const email = emailInput.value.trim();
                if (!email) {
                    showCustomAlert('请输入QQ邮箱！', 'error');
                    return;
                }
                if (!email.endsWith('@qq.com')) {
                    showCustomAlert('仅支持QQ邮箱注册！', 'error');
                    return;
                }

                captchaBtn.disabled = true;
                captchaBtn.innerText = '发送中...';

                fetch(`{% url 'BLauth:captcha' %}?email=${email}`)
                    .then(res => res.json())  // 只有请求成功（200）才会进入这里
                    .then(data => {
                        if (data.code === 200) {
                            showCustomAlert('验证码已发送至您的QQ邮箱！', 'success');
                            let count = 60;
                            const timer = setInterval(() => {
                                captchaBtn.innerText = `重新发送(${count}s)`;
                                count--;
                                if (count < 0) {
                                    clearInterval(timer);
                                    captchaBtn.innerText = '获取验证码';
                                    captchaBtn.disabled = false;
                                }
                            }, 1000);
                        } else {
                            // 后端返回的业务错误（400/500）
                            showCustomAlert(data.message, 'error');
                            captchaBtn.disabled = false;
                            captchaBtn.innerText = '获取验证码';
                        }
                    })
                    .catch(err => {
                        // 真正的网络错误（断网、请求超时、服务器挂了）
                        showCustomAlert('网络错误，请检查网络后重试！', 'error');
                        captchaBtn.disabled = false;
                        captchaBtn.innerText = '获取验证码';
                    });
            });

            // 表单提交校验
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                const captcha = captchaInput.value.trim();

                if (!username) {
                    showCustomAlert('请输入用户名！', 'error');
                    usernameInput.focus();
                    return;
                }
                if (!email || !email.endsWith('@qq.com')) {
                    showCustomAlert('请输入有效的QQ邮箱！', 'error');
                    emailInput.focus();
                    return;
                }
                if (!captcha || captcha.length !== 4) {
                    showCustomAlert('请输入4位验证码！', 'error');
                    captchaInput.focus();
                    return;
                }
                if (password.length < 6 || password.length > 20) {
                    showCustomAlert('密码长度需在6-20位之间！', 'error');
                    passwordInput.focus();
                    return;
                }
                this.submit();
            });

            // 修复：统一错误提示逻辑（包括自定义重复注册错误）
            {% if form.errors or custom_error %}
                {% if custom_error %}
                    showCustomAlert('{{ custom_error }}', 'error');
                {% else %}
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            showCustomAlert('{{ error }}', 'error');
                        {% endfor %}
                    {% endfor %}
                {% endif %}
            {% endif %}
        });
    </script>
{% endblock %}